
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.9">
    
    
      
        <title>后端Python项目常用工具解答文档 - 听语林</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.120efc48.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9647289d.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="听语林" class="md-header__button md-logo" aria-label="听语林" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            听语林
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              后端Python项目常用工具解答文档
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="暗色模式"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="暗色模式" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="" data-md-color-primary="red" data-md-color-accent="red"  aria-label="亮色模式"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="亮色模式" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="./" class="md-tabs__link md-tabs__link--active">
        liquidnetwork
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="听语林" class="md-nav__button md-logo" aria-label="听语林" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    听语林
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          liquidnetwork
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="liquidnetwork" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          liquidnetwork
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          后端Python项目常用工具解答文档
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        后端Python项目常用工具解答文档
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    写法
  </a>
  
    <nav class="md-nav" aria-label="写法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    应用创建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    接口编写与返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    包
  </a>
  
    <nav class="md-nav" aria-label="包">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#marshmallow" class="md-nav__link">
    marshmallow
  </a>
  
    <nav class="md-nav" aria-label="marshmallow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1scheme" class="md-nav__link">
    1、Scheme
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2serializing" class="md-nav__link">
    2、Serializing(序列化)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、过滤输出
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4deserializing" class="md-nav__link">
    4、Deserializing(反序列化)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5、处理多个对象的集合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6validation" class="md-nav__link">
    6、Validation(验证)
  </a>
  
    <nav class="md-nav" aria-label="6、Validation(验证)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    6.1 自定义验证信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-schema" class="md-nav__link">
    6.2 将验证函数写在Schema中变成验证方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-required-fields" class="md-nav__link">
    6.3 Required Fields(必填选项)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    6.4 指定默认值
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65" class="md-nav__link">
    6.5 对未知字段的处理
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7schemavalidate" class="md-nav__link">
    7、Schema.validate(校验数据)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-specifying-serializationdeserialization-keys" class="md-nav__link">
    8. Specifying Serialization/Deserialization Keys(指定序列化/反序列化键)
  </a>
  
    <nav class="md-nav" aria-label="8. Specifying Serialization/Deserialization Keys(指定序列化/反序列化键)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-specifying-attribute-namesobjectfields" class="md-nav__link">
    8.1 Specifying Attribute Names(序列化时指定object属性对应fields字段)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-fieldsobject" class="md-nav__link">
    8.2 反序列化时指定fields字段对应object属性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-key" class="md-nav__link">
    8.3 让key同时满足序列化与反序列化的方法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    9. 重构：创建隐式字段
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    10. 排序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    11. “只读”与“只写”字段
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    12. 序列化/反序列化时指定字段的默认值
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    13. 后续扩展
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webargs" class="md-nav__link">
    webargs
  </a>
  
    <nav class="md-nav" aria-label="webargs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    使用示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flask-apispec" class="md-nav__link">
    flask-apispec
  </a>
  
    <nav class="md-nav" aria-label="flask-apispec">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    下载安装
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    使用实例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    项目中使用实例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongoengine" class="md-nav__link">
    mongoengine
  </a>
  
    <nav class="md-nav" aria-label="mongoengine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1 连接数据库
  </a>
  
    <nav class="md-nav" aria-label="1 连接数据库">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11_1" class="md-nav__link">
    1.1 多种连接方式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12_1" class="md-nav__link">
    1.2 连接多个数据库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13_1" class="md-nav__link">
    1.3 上下文管理器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2 定义文档
  </a>
  
    <nav class="md-nav" aria-label="2 定义文档">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-document" class="md-nav__link">
    2.1 定义文档模型(document)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-dynamic-document" class="md-nav__link">
    2.2 定义动态文档模型(Dynamic Document)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-fields" class="md-nav__link">
    2.3 字段Fields
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-indexes" class="md-nav__link">
    2.4 索引 Indexes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25" class="md-nav__link">
    2.5 抽象类
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26" class="md-nav__link">
    2.6 文档实例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27" class="md-nav__link">
    2.7 查询文档
  </a>
  
    <nav class="md-nav" aria-label="2.7 查询文档">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    字符串查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    原始查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    限制与跳过查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    聚合查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    限制查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    高级查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    原子更新
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#celery" class="md-nav__link">
    celery
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    抓包开发
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/" class="md-nav__link">
        后端开发流程与开发规范
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    写法
  </a>
  
    <nav class="md-nav" aria-label="写法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    应用创建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    接口编写与返回
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    包
  </a>
  
    <nav class="md-nav" aria-label="包">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#marshmallow" class="md-nav__link">
    marshmallow
  </a>
  
    <nav class="md-nav" aria-label="marshmallow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1scheme" class="md-nav__link">
    1、Scheme
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2serializing" class="md-nav__link">
    2、Serializing(序列化)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、过滤输出
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4deserializing" class="md-nav__link">
    4、Deserializing(反序列化)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5、处理多个对象的集合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6validation" class="md-nav__link">
    6、Validation(验证)
  </a>
  
    <nav class="md-nav" aria-label="6、Validation(验证)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    6.1 自定义验证信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-schema" class="md-nav__link">
    6.2 将验证函数写在Schema中变成验证方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-required-fields" class="md-nav__link">
    6.3 Required Fields(必填选项)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    6.4 指定默认值
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65" class="md-nav__link">
    6.5 对未知字段的处理
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7schemavalidate" class="md-nav__link">
    7、Schema.validate(校验数据)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-specifying-serializationdeserialization-keys" class="md-nav__link">
    8. Specifying Serialization/Deserialization Keys(指定序列化/反序列化键)
  </a>
  
    <nav class="md-nav" aria-label="8. Specifying Serialization/Deserialization Keys(指定序列化/反序列化键)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-specifying-attribute-namesobjectfields" class="md-nav__link">
    8.1 Specifying Attribute Names(序列化时指定object属性对应fields字段)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-fieldsobject" class="md-nav__link">
    8.2 反序列化时指定fields字段对应object属性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-key" class="md-nav__link">
    8.3 让key同时满足序列化与反序列化的方法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    9. 重构：创建隐式字段
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    10. 排序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    11. “只读”与“只写”字段
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    12. 序列化/反序列化时指定字段的默认值
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    13. 后续扩展
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webargs" class="md-nav__link">
    webargs
  </a>
  
    <nav class="md-nav" aria-label="webargs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    使用示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flask-apispec" class="md-nav__link">
    flask-apispec
  </a>
  
    <nav class="md-nav" aria-label="flask-apispec">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    下载安装
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    使用实例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    项目中使用实例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongoengine" class="md-nav__link">
    mongoengine
  </a>
  
    <nav class="md-nav" aria-label="mongoengine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1 连接数据库
  </a>
  
    <nav class="md-nav" aria-label="1 连接数据库">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11_1" class="md-nav__link">
    1.1 多种连接方式
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12_1" class="md-nav__link">
    1.2 连接多个数据库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13_1" class="md-nav__link">
    1.3 上下文管理器
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2 定义文档
  </a>
  
    <nav class="md-nav" aria-label="2 定义文档">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-document" class="md-nav__link">
    2.1 定义文档模型(document)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-dynamic-document" class="md-nav__link">
    2.2 定义动态文档模型(Dynamic Document)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-fields" class="md-nav__link">
    2.3 字段Fields
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-indexes" class="md-nav__link">
    2.4 索引 Indexes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25" class="md-nav__link">
    2.5 抽象类
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26" class="md-nav__link">
    2.6 文档实例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27" class="md-nav__link">
    2.7 查询文档
  </a>
  
    <nav class="md-nav" aria-label="2.7 查询文档">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    字符串查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    原始查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    限制与跳过查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    聚合查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    限制查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    高级查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    原子更新
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#celery" class="md-nav__link">
    celery
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    抓包开发
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<p>[toc]</p>
<h1 id="_1">文档说明<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>本文用于解释当前流体网络后端 <code>Python</code> 项目中部分写法的解释和一些引用的第三方包功能的使用。</p>
<blockquote>
<p>本文以 <code>poros</code> 项目为例(下文不再具体说明)，本文写作时其代码结构如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="o">.</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="err">├──</span> <span class="n">admin_app</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="err">├──</span> <span class="n">app</span><span class="o">.</span><span class="n">py</span>  <span class="c1"># 服务入口文件</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="err">├──</span> <span class="n">apps</span>  <span class="c1"># 包含 app工厂和其他功能逻辑</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="err">├──</span> <span class="n">celery_app</span><span class="o">.</span><span class="n">py</span>  <span class="c1"># 新建一个 celery app</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="err">├──</span> <span class="n">common</span>  <span class="c1"># 为解决冲突新建的文件(未确定)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="err">├──</span> <span class="n">conf</span>  <span class="c1"># 配置文件</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="err">├──</span> <span class="n">data</span>  <span class="c1"># 前端礼物列表</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="err">├──</span> <span class="n">entity</span>  <span class="c1"># mongodb 的存储对象</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="err">├──</span> <span class="n">errors</span>  <span class="c1"># 基础错误类自定义集合</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="err">├──</span> <span class="n">female_logic</span>  <span class="c1"># 女嘉宾上麦奖励逻辑</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="err">├──</span> <span class="n">ipython_config</span><span class="o">.</span><span class="n">py</span>  <span class="c1"># ipython 配置文件(疑似无效)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="err">├──</span> <span class="n">log_config</span><span class="o">.</span><span class="n">py</span>  <span class="c1"># 日志配置并初始化部分logger对象</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="err">├──</span> <span class="n">logic</span>  <span class="c1"># 主要业务逻辑代码实现</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="err">├──</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span>  <span class="c1"># 一个业务脚本，以ipython方式打印结果</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="err">├──</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">py</span>  <span class="c1"># 初始化redis实例</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="err">├──</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="err">├──</span> <span class="n">restart</span><span class="o">.</span><span class="n">sh</span>  <span class="c1"># shell方式重启系统脚本</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="err">├──</span> <span class="n">run</span>  <span class="c1"># 启动文件配置集合</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="err">├──</span> <span class="n">schema</span>  <span class="c1"># orm 实现序列化的集合</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="err">├──</span> <span class="n">setup</span>  <span class="c1"># docker配置及程序启动shell脚本</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="err">├──</span> <span class="n">shell_script</span>  <span class="c1"># shell 脚本</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="err">├──</span> <span class="n">tasks</span>  <span class="c1"># 异步任务集合</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="err">├──</span> <span class="n">templates</span>  <span class="c1"># 后台前端文件</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="err">├──</span> <span class="n">test</span>  <span class="c1"># 单元测试文件集合</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="err">├──</span> <span class="n">tmp_scripts</span>  <span class="c1"># 临时脚本集合</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="err">├──</span> <span class="n">util</span>  <span class="c1"># 通用工具集合</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="err">└──</span> <span class="n">views</span>  <span class="c1"># 对外接口集合</span>
</code></pre></div>
</blockquote>
<h2 id="_2">写法<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">应用创建<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>项目创建采用<a href="https://dormousehole.readthedocs.io/en/latest/patterns/appfactories.html?highlight=create_app">应用工厂</a>的方式创建<code>app</code>, 并初始化应用的基本功能.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># app.py</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">from</span> <span class="nn">apps</span> <span class="kn">import</span> <span class="n">create_app</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="c1"># apps/__init__.py</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config_object</span><span class="o">=</span><span class="s1">&#39;conf.settings&#39;</span><span class="p">):</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    <span class="sd">&quot;&quot;&quot;Create application factory, as explained here: http://flask.pocoo.org/docs/patterns/appfactories/.&quot;&quot;&quot;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config_object</span><span class="p">)</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="n">configure_logger</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    <span class="n">filter_warning</span><span class="p">()</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>    <span class="n">register_extensions</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    <span class="n">register_sentry</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>    <span class="n">register_json_encoder</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    <span class="c1"># register_db(app)</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>    <span class="n">register_redis</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    <span class="n">register_blueprints</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    <span class="n">register_apispec</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>    <span class="n">register_errorhandler</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>    <span class="n">register_request_handle</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    <span class="c1"># register_ab_test()</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
<p>具体初始化功能如下：</p>
<ul>
<li>导入配置文件</li>
</ul>
<p>导入文件方式为配置对象加载。讲配置文件名称作为对象名称导入</p>
<ul>
<li>
<p>初始化日志级别</p>
</li>
<li>
<p>配置<code>warning</code>日志过滤器。忽略<code>warning</code>日志</p>
</li>
<li>
<p>初始化插件(设置缓存记录器为<code>redis</code>,设置四个不同业务场景的异步<code>celery</code>)</p>
</li>
<li>
<p>注册<code>sentry</code>日志监察模块</p>
</li>
<li>
<p>自定义应用<code>json</code>序列化器</p>
</li>
<li>
<p>连接<code>redis</code></p>
</li>
<li>
<p>注册蓝图</p>
</li>
<li>
<p>注册<code>swagger api</code>管理模块</p>
</li>
<li>
<p>自定义错误处理模块</p>
</li>
<li>
<p>生命周期记录</p>
</li>
</ul>
<p>另有<code>before_request</code>初始化参数位置统一放到<code>request.all_param</code>中</p>
<blockquote>
<p>仅<code>json</code>参数和<code>args</code>参数</p>
</blockquote>
<p>还有<code>after_request</code>统一打印每一个请求的<code>ip</code>地址、具体路径、访问方式、参数内容、返回结果、返回状态等数据。</p>
<blockquote>
<p><code>swagger</code> 和 <code>flask-apispec</code>访问数据不用打印详细日志</p>
</blockquote>
<h3 id="_4">接口编写与返回<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>接口编写采用函数视图，一般辅之以一定的装饰器。</p>
<p>常用的装饰器有作为视图函数的路由设定，参数校验，返回数据限定与格式化，和登录认证四种。</p>
<p>接口业务逻辑内容以 <code>mongodb</code> 和 <code>redis</code> 互相配合，加之一定的业务逻辑为主。</p>
<p>以<code>apps/couple/get_newr_female_list</code>函数为例。截取部分代码如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nd">@couple_app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/near_female/list&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>  <span class="c1"># 路由设置方式</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nd">@use_kwargs</span><span class="p">({</span><span class="s1">&#39;only_voice_room&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;是否开黑房&#39;</span><span class="p">)})</span>  <span class="c1"># 必要参数设置与注释</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="nd">@marshal_with</span><span class="p">(</span><span class="n">NearFemaleSchema</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">apply</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 返回数据格式</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="nd">@login_required</span><span class="p">()</span>  <span class="c1"># 限定登录用户</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="k">def</span> <span class="nf">get_near_female_list</span><span class="p">(</span><span class="n">only_voice_room</span><span class="p">):</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="sd">&quot;&quot;&quot;获取熟人列表&quot;&quot;&quot;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>  <span class="c1"># 限定登录用户接口会由 login_required 装饰器根据用户的 token 查询用户信息并设置对应信息到 request.user 中</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">NearListTest</span><span class="o">.</span><span class="n">is_test_group</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">):</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>        <span class="k">return</span> <span class="n">response_util</span><span class="o">.</span><span class="n">response</span><span class="p">(</span><span class="n">response_util</span><span class="o">.</span><span class="n">RetCodeAndMessage</span><span class="o">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[])</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="c1"># 向 mongodb 查询数据</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="n">rooms</span> <span class="o">=</span> <span class="n">CoupleRoom</span><span class="o">.</span><span class="n">objects_not_delete</span><span class="p">(</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="n">is_online</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">room_type__in</span><span class="o">=</span><span class="p">(</span><span class="n">CoupleRoom</span><span class="o">.</span><span class="n">CoupleRoomType</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">,</span> <span class="n">CoupleRoom</span><span class="o">.</span><span class="n">CoupleRoomType</span><span class="o">.</span><span class="n">FIVE_ROOM</span><span class="p">))</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="k">if</span> <span class="n">only_voice_room</span><span class="p">:</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="n">rooms</span> <span class="o">=</span> <span class="n">rooms</span><span class="p">(</span><span class="n">only_voice_room</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">voice_chatting</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>        <span class="n">rooms</span> <span class="o">=</span> <span class="n">rooms</span><span class="p">(</span><span class="n">only_voice_room__ne</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">voice_chatting</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="n">user_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Real-Ip&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>    <span class="n">test_couple_room_user</span> <span class="o">=</span> <span class="n">rds</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;test_couple_room_user&#39;</span><span class="p">)</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>    <span class="n">near_female_map</span> <span class="o">=</span> <span class="n">NearScoreSvc</span><span class="o">.</span><span class="n">get_near_map</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>    <span class="k">for</span> <span class="n">room</span> <span class="ow">in</span> <span class="n">rooms</span><span class="p">:</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>        <span class="c1"># 测试房间仅公司ip or 测试白名单 显示</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">IsCoupleRoomWhite</span><span class="o">.</span><span class="n">is_white_account</span><span class="p">(</span><span class="n">room</span><span class="o">.</span><span class="n">room_id</span><span class="p">)</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>                <span class="ow">and</span> <span class="n">user_ip</span> <span class="o">!=</span> <span class="n">constants</span><span class="o">.</span><span class="n">OFFICE_IP</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>                <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">test_couple_room_user</span><span class="p">):</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>            <span class="k">continue</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>        <span class="n">on_mic_user_map</span> <span class="o">=</span> <span class="n">room</span><span class="o">.</span><span class="n">get_room_on_mic_user_map</span><span class="p">()</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>        <span class="n">has_male</span> <span class="o">=</span> <span class="n">on_mic_user_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CoupleRoom</span><span class="o">.</span><span class="n">MicPosition</span><span class="o">.</span><span class="n">MIC1</span><span class="p">)</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>        <span class="k">if</span> <span class="n">room</span><span class="o">.</span><span class="n">room_type</span> <span class="o">==</span> <span class="n">CoupleRoom</span><span class="o">.</span><span class="n">CoupleRoomType</span><span class="o">.</span><span class="n">FIVE_ROOM</span><span class="p">:</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>            <span class="n">has_male</span> <span class="o">=</span> <span class="n">has_male</span> <span class="ow">and</span> <span class="n">on_mic_user_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CoupleRoom</span><span class="o">.</span><span class="n">MicPosition</span><span class="o">.</span><span class="n">MIC3</span><span class="p">)</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>        <span class="k">for</span> <span class="n">position</span><span class="p">,</span> <span class="n">mic_info</span> <span class="ow">in</span> <span class="n">on_mic_user_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>            <span class="k">if</span> <span class="n">position</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CoupleRoom</span><span class="o">.</span><span class="n">MicPosition</span><span class="o">.</span><span class="n">ANCHOR</span><span class="p">,</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>                                <span class="n">CoupleRoom</span><span class="o">.</span><span class="n">MicPosition</span><span class="o">.</span><span class="n">MIC2</span><span class="p">,</span> <span class="n">CoupleRoom</span><span class="o">.</span><span class="n">MicPosition</span><span class="o">.</span><span class="n">MIC4</span><span class="p">):</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>                <span class="k">continue</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>            <span class="n">female_id</span> <span class="o">=</span> <span class="n">mic_info</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>            <span class="c1"># 跳过非熟人房间</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>            <span class="k">if</span> <span class="n">female_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">near_female_map</span><span class="p">:</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>                <span class="k">continue</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>            <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>                <span class="s1">&#39;room_id&#39;</span><span class="p">:</span> <span class="n">room</span><span class="o">.</span><span class="n">room_id</span><span class="p">,</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>                <span class="s1">&#39;im_room_id&#39;</span><span class="p">:</span> <span class="n">room</span><span class="o">.</span><span class="n">im_room_id</span><span class="p">,</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>                <span class="s1">&#39;female_uid&#39;</span><span class="p">:</span> <span class="n">female_id</span><span class="p">,</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>                <span class="s1">&#39;status_str&#39;</span><span class="p">:</span> <span class="s1">&#39;开黑中&#39;</span> <span class="k">if</span> <span class="n">room</span><span class="o">.</span><span class="n">voice_chatting</span> <span class="k">else</span> <span class="s1">&#39;正在找CP&#39;</span><span class="p">,</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>                <span class="s1">&#39;has_male&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">has_male</span><span class="p">),</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>                <span class="s1">&#39;room_type&#39;</span><span class="p">:</span> <span class="n">room</span><span class="o">.</span><span class="n">room_type</span><span class="p">,</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>                <span class="s1">&#39;near_score&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">near_female_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">female_id</span><span class="p">)),</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>                <span class="s1">&#39;mic_pos&#39;</span><span class="p">:</span> <span class="n">mic_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>            <span class="p">})</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>    <span class="c1"># 排序 取前20个</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>    <span class="n">data_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;has_male&#39;</span><span class="p">],</span> <span class="o">-</span><span class="n">near_female_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;female_uid&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)))</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>    <span class="n">data_list</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>    <span class="n">fill_user_info</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">user_id_key</span><span class="o">=</span><span class="s1">&#39;female_uid&#39;</span><span class="p">)</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>    <span class="c1"># 自定义response处理器，可缓存接口数据，添加部分参数(im_video_token)</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>    <span class="k">return</span> <span class="n">response_util</span><span class="o">.</span><span class="n">response</span><span class="p">(</span><span class="n">response_util</span><span class="o">.</span><span class="n">RetCodeAndMessage</span><span class="o">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_list</span><span class="p">)</span>
</code></pre></div>
<blockquote>
<ul>
<li>接口的装饰器数量和必要性应根据实际接口请求为准。</li>
<li>返回结果也并不一定完全采用自定义的 <code>response_util.response</code>.(如 <code>poros/views/gift/gift_list_info</code> 视图函数)</li>
</ul>
</blockquote>
<h2 id="_5">包<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>此项目采用主要存储方式为 <code>mongodb</code>，并采用了<code>restful</code>形式的<code>api</code>管理。在代码中涉及到了较多的包的使用。</p>
<p>这里附上部分包的介绍说明和使用方式</p>
<h3 id="marshmallow"><code>marshmallow</code><a class="headerlink" href="#marshmallow" title="Permanent link">&para;</a></h3>
<p><code>marshmallow</code>是一个用来将复杂的<code>orm</code>对象与<code>python</code>原生数据类型之间相互转换的库，简而言之，就是实现<code>object -&gt; dict</code>， <code>objects -&gt; list</code>, <code>string -&gt; dict</code> 和 <code>string -&gt; list</code>。</p>
<blockquote>
<p>序列化：序列化的意思是将数据对象转化为可存储或可传输的数据类型 反序列化：将可存储或可传输的数据类型转化为数据对象
要进行序列化或反序列化，首先我们需要一个用来操作的object，这里我们先定义一个类：</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>        <span class="k">return</span> <span class="s2">&quot;&lt;User(name=</span><span class="si">{self.name!r}</span><span class="s2">)&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
<h4 id="1scheme">1、Scheme<a class="headerlink" href="#1scheme" title="Permanent link">&para;</a></h4>
<p>要对一个类或者一个json数据实现相互转换(即序列化和反序列化), 需要一个中间载体, 这个载体就是Schema，另外Schema还可以用来做数据验证。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="err">#</span> <span class="n">这是一个简单的Scheme</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">from</span> <span class="n">marshmallow</span> <span class="kn">import</span> <span class="nn">Schema</span><span class="p">,</span> <span class="n">fields</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="kd">class</span> <span class="nf">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="na">String</span><span class="p">()</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="na">Email</span><span class="p">()</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="n">created_time</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="na">DateTime</span><span class="p">()</span>
</code></pre></div>
<h4 id="2serializing">2、Serializing(序列化)<a class="headerlink" href="#2serializing" title="Permanent link">&para;</a></h4>
<p>使用scheme的dump()方法来序列化对象，返回的是dict格式的数据</p>
<p>另外schema的dumps()方法序列化对象，返回的是json编码格式的字符串。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s">&quot;lhh&quot;</span><span class="p">,</span><span class="s">&quot;2432783449@qq.com&quot;</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="na">dump</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="n">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="err">#</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">email</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="mi">2432783449</span><span class="nd">@qq.com</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">created_time</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="mi">2021</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">28</span> <span class="mi">20</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">08.946112</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">lhh</span><span class="err">&#39;</span><span class="p">}</span>  <span class="n">dict</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="n">res2</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="na">dumps</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="n">print</span><span class="p">(</span><span class="n">res2</span><span class="p">)</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="err">#</span> <span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;lhh&quot;</span><span class="p">,</span> <span class="s">&quot;email&quot;</span><span class="p">:</span> <span class="s">&quot;2432783449@qq.com&quot;</span><span class="p">,</span> <span class="s">&quot;created_time&quot;</span><span class="p">:</span> <span class="s">&quot;2021-05-28 20:45:17.418739&quot;</span><span class="p">}</span><span class="err">&#39;</span>  <span class="n">json</span>
</code></pre></div>
<h4 id="3">3、过滤输出<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<p>当不需要输出所有的字段时，可以在实例化Scheme时，声明only参数，来指定输出：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">summary_schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">,</span><span class="s">&quot;email&quot;</span><span class="p">})</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">res</span> <span class="o">=</span> <span class="n">summary_schema</span><span class="p">.</span><span class="na">dump</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="err">#</span> <span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;lhh&quot;</span><span class="p">,</span> <span class="s">&quot;email&quot;</span><span class="p">:</span> <span class="s">&quot;2432783449@qq.com&quot;</span><span class="p">}</span>
</code></pre></div>
<h4 id="4deserializing">4、Deserializing(反序列化)<a class="headerlink" href="#4deserializing" title="Permanent link">&para;</a></h4>
<p>schema的load()方法与dump()方法相反，用于dict类型的反序列化。他将输入的字典格式数据转换成应用层数据结构。他也能起到验证输入的字典格式数据的作用。 同样，也有对json解码的loads()方法。用于string类型的反序列化。 默认情况下，load()方法返回一个字典，当输入的数据的值不匹配字段类型时，抛出 ValidationError 异常。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;lhh&quot;</span><span class="p">,</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="s">&quot;email&quot;</span><span class="p">:</span> <span class="s">&quot;2432783449@qq.com&quot;</span><span class="p">,</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="s">&quot;created_time&quot;</span><span class="p">:</span> <span class="s">&quot;2021-05-28 20:45:17.418739&quot;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="p">}</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="n">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="err">#</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">created_time</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="mi">2021</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">28</span> <span class="mi">20</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mf">17.418739</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">email</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="mi">2432783449</span><span class="nd">@qq.com</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">lhh</span><span class="err">&#39;</span><span class="p">}</span>
</code></pre></div>
<p>对反序列化而言, 将传入的dict变成object更加有意义. 在Marshmallow中, dict -&gt; object的方法需要自己实现, 然后在该方法前面加上一个装饰器post_load即可</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kd">class</span> <span class="nf">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="na">String</span><span class="p">()</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="na">Email</span><span class="p">()</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="n">created_time</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="na">DateTime</span><span class="p">()</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="nd">@post_load</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="n">def</span> <span class="nf">make_user</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>        <span class="k">return</span> <span class="n">User</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
<p>这样每次调用load()方法时, 会按照make_user的逻辑, 返回一个User类对象。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;lhh&quot;</span><span class="p">,</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="s">&quot;email&quot;</span><span class="p">:</span> <span class="s">&quot;2432783449@qq.com&quot;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="p">}</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="n">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="err">#</span> <span class="o">&lt;</span><span class="n">__main__</span><span class="p">.</span><span class="na">User</span> <span class="n">object</span> <span class="n">at</span> <span class="mh">0x0000027BE9678128</span><span class="o">&gt;</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="n">user</span> <span class="o">=</span> <span class="n">res</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="nf">print</span><span class="p">(</span><span class="s">&quot;name: {}    email: {}&quot;</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">name</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="na">email</span><span class="p">))</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="err">#</span> <span class="n">name</span><span class="p">:</span> <span class="n">lhh</span>    <span class="n">email</span><span class="p">:</span> <span class="mi">2432783449</span><span class="nd">@qq.com</span>
</code></pre></div>
<h4 id="5">5、处理多个对象的集合<a class="headerlink" href="#5" title="Permanent link">&para;</a></h4>
<p>多个对象的集合如果是可迭代的，那么也可以直接对这个集合进行序列化或者反序列化。在实例化Scheme类时设置参数many=True</p>
<p>也可以不在实例化类的时候设置，而在调用dump()方法的时候传入这个参数。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">user1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;lhh1&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">&quot;2432783449@qq.com&quot;</span><span class="p">)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">user2</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;lhh2&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">&quot;2432783449@qq.com&quot;</span><span class="p">)</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">users</span> <span class="o">=</span> <span class="o">[</span><span class="n">user1</span><span class="p">,</span> <span class="n">user2</span><span class="o">]</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="err">#</span> <span class="n">第一种方法</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="na">dump</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="n">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="err">#</span> <span class="n">第二种方法</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="na">dump</span><span class="p">(</span><span class="n">users</span><span class="p">,</span><span class="n">many</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="n">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="err">#</span> <span class="o">[</span><span class="p">{</span><span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="p">:</span> <span class="n">u</span><span class="err">&#39;</span><span class="n">Mick</span><span class="err">&#39;</span><span class="p">,</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="err">#</span>   <span class="err">&#39;</span><span class="n">email</span><span class="err">&#39;</span><span class="p">:</span> <span class="n">u</span><span class="err">&#39;</span><span class="n">mick</span><span class="nd">@stones.com</span><span class="err">&#39;</span><span class="p">,</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="err">#</span>   <span class="err">&#39;</span><span class="n">created_at</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">17</span><span class="n">T14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mf">57.600623</span><span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="err">&#39;</span><span class="p">}</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="err">#</span>  <span class="p">{</span><span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="p">:</span> <span class="n">u</span><span class="err">&#39;</span><span class="n">Keith</span><span class="err">&#39;</span><span class="p">,</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="err">#</span>   <span class="err">&#39;</span><span class="n">email</span><span class="err">&#39;</span><span class="p">:</span> <span class="n">u</span><span class="err">&#39;</span><span class="n">keith</span><span class="nd">@stones.com</span><span class="err">&#39;</span><span class="p">,</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="err">#</span>   <span class="err">&#39;</span><span class="n">created_at</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="mi">2014</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">17</span><span class="n">T14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mf">57.600623</span><span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="err">&#39;</span><span class="p">}</span><span class="o">]</span>
</code></pre></div>
<h4 id="6validation">6、Validation(验证)<a class="headerlink" href="#6validation" title="Permanent link">&para;</a></h4>
<p>当不合法的数据通过Schema.load()或者Schema.loads()时，会抛出一个 ValidationError 异常。ValidationError.messages属性有验证错误信息，验证通过的数据在 ValidationError.valid_data 属性中 我们捕获这个异常，然后做异常处理。首先需要导入ValidationError这个异常</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">from</span> <span class="n">marshmallow</span> <span class="kn">import</span> <span class="nn">Schema</span><span class="p">,</span><span class="n">fields</span><span class="p">,</span><span class="n">ValidationError</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="kd">class</span> <span class="nf">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="na">String</span><span class="p">()</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="na">Email</span><span class="p">()</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    <span class="n">created_time</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="na">DateTime</span><span class="p">()</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="nl">try</span><span class="p">:</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">().</span><span class="na">load</span><span class="p">({</span><span class="s">&quot;name&quot;</span><span class="p">:</span><span class="s">&quot;lhh&quot;</span><span class="p">,</span><span class="s">&quot;email&quot;</span><span class="p">:</span><span class="s">&quot;lhh&quot;</span><span class="p">})</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="n">except</span> <span class="n">ValidationError</span> <span class="n">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>    <span class="n">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;错误信息：{e.messages}  合法数据:{e.valid_data}&quot;</span><span class="p">)</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="sc">&#39;&#39;&#39;</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="n">当验证一个数据集合的时候</span><span class="err">，</span><span class="n">返回的错误信息会以</span> <span class="n">错误序号</span><span class="o">-</span><span class="n">错误信息</span> <span class="n">的键值对形式保存在errors中</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="sc">&#39;&#39;&#39;</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="n">user_data</span> <span class="o">=</span> <span class="o">[</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>    <span class="p">{</span><span class="err">&#39;</span><span class="n">email</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="mi">2432783449</span><span class="nd">@qq.com</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">lhh</span><span class="err">&#39;</span><span class="p">},</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>    <span class="p">{</span><span class="err">&#39;</span><span class="n">email</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">invalid</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">Invalid</span><span class="err">&#39;</span><span class="p">},</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>    <span class="p">{</span><span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">wcy</span><span class="err">&#39;</span><span class="p">},</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>    <span class="p">{</span><span class="err">&#39;</span><span class="n">email</span><span class="err">&#39;</span><span class="p">:</span> <span class="err">&#39;</span><span class="mi">2432783449</span><span class="nd">@qq.com</span><span class="err">&#39;</span><span class="p">},</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="o">]</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="nl">try</span><span class="p">:</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    <span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>    <span class="n">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="n">except</span> <span class="n">ValidationError</span> <span class="n">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>    <span class="n">print</span><span class="p">(</span><span class="s">&quot;错误信息：{}   合法数据：{}&quot;</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">messages</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="na">valid_data</span><span class="p">))</span>
</code></pre></div>
<p>可以看到上面，有错误信息，但是对于没有传入的属性则没有检查，也就是说没有规定属性必须传入。</p>
<p>在Schema里规定不可缺省字段：设置参数required=True</p>
<blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>可以看到上面，有错误信息，但是对于没有传入的属性则没有检查，也就是说没有规定属性必须传入。 在Schema里规定不可缺省字段：设置参数required=True
</code></pre></div>
</blockquote>
<h5 id="61">6.1 自定义验证信息<a class="headerlink" href="#61" title="Permanent link">&para;</a></h5>
<p>在编写Schema类的时候，可以向内建的fields中设置validate参数的值来定制验证的逻辑, validate的值可以是函数, 匿名函数lambda, 或者是定义了**call**的对象。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span><span class="n">fields</span><span class="p">,</span><span class="n">ValidationError</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">()</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="n">created_time</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">()</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;InvalidName&quot;</span><span class="p">,</span><span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;2432783449@qq.com&quot;</span><span class="p">}</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>
</code></pre></div>
<p><strong>在验证函数中自定义异常信息：</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1">#encoding=utf-8</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span><span class="n">fields</span><span class="p">,</span><span class="n">ValidationError</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="k">def</span> <span class="nf">validate_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;=</span><span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;name长度必须大于2位&quot;</span><span class="p">)</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;name长度不能大于6位&quot;</span><span class="p">)</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate_name</span><span class="p">)</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">()</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>    <span class="n">created_time</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">()</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;InvalidName&quot;</span><span class="p">,</span><span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;2432783449@qq.com&quot;</span><span class="p">}</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>
</code></pre></div>
<p><code>注意</code>：只会在反序列化的时候发生验证！序列化的时候不会验证！</p>
<h5 id="62-schema">6.2 将验证函数写在Schema中变成验证方法<a class="headerlink" href="#62-schema" title="Permanent link">&para;</a></h5>
<p>在Schema中，使用validates装饰器就可以注册验证方法。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1">#encoding=utf-8</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">validates</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">()</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>    <span class="n">created_time</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">()</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="nd">@validates</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="k">def</span> <span class="nf">validate_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;name长度必须大于2位&quot;</span><span class="p">)</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;name长度不能大于6位&quot;</span><span class="p">)</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;InvalidName&quot;</span><span class="p">,</span><span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;2432783449@qq.com&quot;</span><span class="p">}</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>
</code></pre></div>
<h5 id="63-required-fields">6.3 Required Fields(必填选项)<a class="headerlink" href="#63-required-fields" title="Permanent link">&para;</a></h5>
<p>上面已经简单使用过required参数了。这里再简单介绍一下。</p>
<p><strong>自定义required异常信息：</strong></p>
<p>首先我们可以自定义在requird=True时缺失字段时抛出的异常信息：设置参数error_messages的值</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1">#encoding=utf-8</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">validates</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_messages</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;required&quot;</span><span class="p">:</span><span class="s2">&quot;name字段必须的&quot;</span><span class="p">})</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">()</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>    <span class="n">created_time</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">()</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>    <span class="nd">@validates</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="k">def</span> <span class="nf">validate_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;name长度必须大于2位&quot;</span><span class="p">)</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;name长度不能大于6位&quot;</span><span class="p">)</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;2432783449@qq.com&quot;</span><span class="p">}</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>
</code></pre></div>
<p><strong>Partial Loading忽略验证：</strong></p>
<p>使用required之后我们还是可以在传入数据的时候忽略这个必填字段。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="err">#</span><span class="n">encoding</span><span class="o">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">from</span> <span class="n">marshmallow</span> <span class="kn">import</span> <span class="nn">Schema</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">validates</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="kd">class</span> <span class="nf">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="na">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="n">age</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="na">Integer</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="err">#</span> <span class="n">方法一</span><span class="err">：</span><span class="n">在load</span><span class="p">()</span><span class="n">方法设置partial参数的值</span><span class="p">(</span><span class="n">元组</span><span class="p">)</span><span class="err">，</span><span class="n">表时忽略那些字段</span><span class="err">。</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="na">load</span><span class="p">({</span><span class="s">&quot;age&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">},</span> <span class="n">partial</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,))</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="n">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="err">#</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">age</span><span class="err">&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">}</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="err">#</span> <span class="n">方法二</span><span class="err">：</span><span class="n">直接设置partial</span><span class="o">=</span><span class="n">True</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="na">load</span><span class="p">({</span><span class="s">&quot;age&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">},</span> <span class="n">partial</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="n">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="err">#</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">age</span><span class="err">&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">}</span>
</code></pre></div>
<p>看起来两种方法是一样的，但是方法一和方法二有区别：方法一只忽略传入partial的字段，方法二会忽略除前面传入的数据里已有的字段之外的所有字段</p>
<h5 id="64">6.4 指定默认值<a class="headerlink" href="#64" title="Permanent link">&para;</a></h5>
<p><code>load_default</code>指定默认的反序列化值</p>
<p><code>dump_default</code>指定默认的序列化值</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">load_default</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">)</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="n">birthdate</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(</span><span class="n">dump_default</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">29</span><span class="p">))</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="n">UserSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">({})</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="c1"># {&#39;id&#39;: UUID(&#39;337d946c-32cd-11e8-b475-0022192ed31b&#39;)}</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="n">UserSchema</span><span class="p">()</span><span class="o">.</span><span class="n">dump</span><span class="p">({})</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="c1"># {&#39;birthdate&#39;: &#39;2017-09-29T00:00:00+00:00&#39;}</span>
</code></pre></div>
<h5 id="65">6.5 对未知字段的处理<a class="headerlink" href="#65" title="Permanent link">&para;</a></h5>
<p>默认情况下，如果传入了未知的字段(Schema里没有的字段)，执行load()方法会抛出一个 ValidationError 异常。这种行为可以通过更改 unknown 选项来修改。</p>
<p>unknown 有三个值：</p>
<ul>
<li>EXCLUDE: exclude unknown fields(直接扔掉未知字段)</li>
<li>INCLUDE: accept and include the unknown fields(接受未知字段)</li>
<li>RAISE: raise a ValidationError if there are any unknown fields(抛出异常)</li>
</ul>
<p>我们可以看到，默认的行为就是RAISE。有两种方法去更改：</p>
<p>方法一：在编写Schema类的时候在class Meta里修改</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">EXCLUDE</span><span class="p">,</span><span class="n">Schema</span><span class="p">,</span><span class="n">fields</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">error_messages</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="s2">&quot;name字段必须填写&quot;</span><span class="p">})</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">()</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>    <span class="n">created_time</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">()</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>        <span class="n">unknown</span>  <span class="o">=</span> <span class="n">EXCLUDE</span>
</code></pre></div>
<p>方法二：在实例化Schema类的时候设置参数unknown的值</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_messages</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="s2">&quot;name字段必须填写&quot;</span><span class="p">})</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">()</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>    <span class="n">created_time</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">()</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="n">shema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">(</span><span class="n">unknown</span><span class="o">=</span><span class="n">EXCLUDE</span><span class="p">)</span>
</code></pre></div>
<h4 id="7schemavalidate">7、Schema.validate(校验数据)<a class="headerlink" href="#7schemavalidate" title="Permanent link">&para;</a></h4>
<p>如果只是想用Schema去验证数据, 而不进行反序列化生成对象, 可以使用Schema.validate() 可以看到, 通过schema.validate()会自动对数据进行校验, 如果有错误, 则会返回错误信息的dict,没有错误则返回空的dict，通过返回的数据, 我们就可以确认验证是否通过.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1">#encoding=utf-8</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span><span class="n">fields</span><span class="p">,</span><span class="n">ValidationError</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_messages</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="s2">&quot;name字段必须填写&quot;</span><span class="p">})</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">()</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="n">created_time</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">()</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="n">user</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;lhh&quot;</span><span class="p">,</span><span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;2432783449&quot;</span><span class="p">}</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>  <span class="c1"># {&#39;email&#39;: [&#39;Not a valid email address.&#39;]}</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="n">user</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;lhh&quot;</span><span class="p">,</span><span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;2432783449@qq.com&quot;</span><span class="p">}</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>  <span class="c1"># {}</span>
</code></pre></div>
<h4 id="8-specifying-serializationdeserialization-keys">8. Specifying Serialization/Deserialization Keys(指定序列化/反序列化键)<a class="headerlink" href="#8-specifying-serializationdeserialization-keys" title="Permanent link">&para;</a></h4>
<h5 id="81-specifying-attribute-namesobjectfields">8.1 Specifying Attribute Names(序列化时指定object属性对应fields字段)<a class="headerlink" href="#81-specifying-attribute-namesobjectfields" title="Permanent link">&para;</a></h5>
<p>Schema默认会序列化传入对象和自身定义的fields相同的属性, 然而你也会有需求使用不同的fields和属性名. 在这种情况下, 你需要明确定义这个fields将从什么属性名取值</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">fields</span><span class="p">,</span><span class="n">Schema</span><span class="p">,</span><span class="n">ValidationError</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>    <span class="n">full_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>    <span class="n">email_address</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;email&quot;</span><span class="p">)</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>    <span class="n">created_at</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;created_time&quot;</span><span class="p">)</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;lhh&quot;</span><span class="p">,</span><span class="n">email</span><span class="o">=</span><span class="s2">&quot;2432783449@qq.com&quot;</span><span class="p">)</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="c1"># {&#39;email_address&#39;: &#39;2432783449@qq.com&#39;, &#39;full_name&#39;: &#39;lhh&#39;, &#39;created_at&#39;: &#39;2021-05-29T09:24:38.186191&#39;}</span>
</code></pre></div>
<p>如上所示：UserSchema中的full_name，email_address，created_at分别从User对象的name，email，created_time属性取值。</p>
<h5 id="82-fieldsobject">8.2 反序列化时指定fields字段对应object属性<a class="headerlink" href="#82-fieldsobject" title="Permanent link">&para;</a></h5>
<p>这个与上面相反，Schema默认反序列化传入字典和输出字典中相同的字段名. 如果你觉得数据不匹配你的schema, 可以传入load_from参数指定需要增加load的字段名(原字段名也能load, 且优先load原字段名)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">fields</span><span class="p">,</span><span class="n">Schema</span><span class="p">,</span><span class="n">ValidationError</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>    <span class="n">full_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">load_from</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>    <span class="n">email_address</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">(</span><span class="n">load_from</span><span class="o">=</span><span class="s2">&quot;email&quot;</span><span class="p">)</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>    <span class="n">created_at</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(</span><span class="n">load_from</span><span class="o">=</span><span class="s2">&quot;created_time&quot;</span><span class="p">)</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="n">user</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;full_name&quot;</span><span class="p">:</span><span class="s2">&quot;lhh&quot;</span><span class="p">,</span><span class="s2">&quot;email_address&quot;</span><span class="p">:</span><span class="s2">&quot;2432783449@qq.com&quot;</span><span class="p">}</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="c1"># {&#39;full_name&#39;: &#39;lhh&#39;, &#39;email_address&#39;: &#39;2432783449@qq.com&#39;}</span>
</code></pre></div>
<h5 id="83-key">8.3 让key同时满足序列化与反序列化的方法<a class="headerlink" href="#83-key" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1">#encoding=utf-8</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">fields</span><span class="p">,</span><span class="n">ValidationError</span><span class="p">,</span><span class="n">Schema</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>    <span class="n">full_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">data_key</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>    <span class="n">email_address</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Email</span><span class="p">(</span><span class="n">data_key</span><span class="o">=</span><span class="s2">&quot;email&quot;</span><span class="p">)</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>    <span class="n">created_at</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(</span><span class="n">data_key</span><span class="o">=</span><span class="s2">&quot;created_time&quot;</span><span class="p">)</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="c1"># 序列化</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="n">user</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;lhh&quot;</span><span class="p">,</span> <span class="s2">&quot;email_address&quot;</span><span class="p">:</span> <span class="s2">&quot;2432783449@qq.com&quot;</span><span class="p">}</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="c1"># {&#39;name&#39;: &#39;lhh&#39;, &#39;email&#39;: &#39;2432783449@qq.com&#39;}</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="c1"># 反序列化</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="n">user</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;lhh&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;2432783449@qq.com&#39;</span><span class="p">}</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="c1"># {&#39;full_name&#39;: &#39;lhh&#39;, &#39;email_address&#39;: &#39;2432783449@qq.com&#39;}</span>
</code></pre></div>
<h4 id="9">9. 重构：创建隐式字段<a class="headerlink" href="#9" title="Permanent link">&para;</a></h4>
<p>当Schema具有许多属性时，为每个属性指定字段类型可能会重复，特别是当许多属性已经是本地python的数据类型时。class Meta允许指定要序列化的属性，marshmallow将根据属性的类型选择适当的字段类型。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># 重构Schema</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>    <span class="n">uppername</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;uppername&quot;</span><span class="p">)</span>
</code></pre></div>
<p>以上代码中， name将自动被格式化为String类型，created_at将被格式化为DateTime类型。</p>
<p>如果您希望指定除了显式声明的字段之外还包括哪些字段名，则可以使用附加选项。如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>    <span class="n">uppername</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>        <span class="c1"># No need to include &#39;uppername&#39;</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>        <span class="n">additional</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="10">10. 排序<a class="headerlink" href="#10" title="Permanent link">&para;</a></h4>
<p>对于某些用例，维护序列化输出的字段顺序可能很有用。要启用排序，请将ordered选项设置为true。这将指示marshmallow将数据序列化到<code>collections.OrderedDict</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">fields</span><span class="p">,</span><span class="n">ValidationError</span><span class="p">,</span><span class="n">Schema</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>    <span class="n">uppername</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;created_time&quot;</span><span class="p">,</span> <span class="s2">&quot;uppername&quot;</span><span class="p">)</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>        <span class="n">ordered</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;lhh&quot;</span><span class="p">,</span> <span class="s2">&quot;2432783449@qq.com&quot;</span><span class="p">)</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="nb">print</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">OrderedDict</span><span class="p">))</span>  <span class="c1"># 判断变量类型</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="c1"># True</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="c1"># OrderedDict([(&#39;name&#39;, &#39;lhh&#39;), (&#39;email&#39;, &#39;2432783449@qq.com&#39;), (&#39;created_time&#39;, &#39;2021-05-29T09:40:46.351382&#39;), (&#39;uppername&#39;, &#39;LHH&#39;)])</span>
</code></pre></div>
<h4 id="11">11. “只读”与“只写”字段<a class="headerlink" href="#11" title="Permanent link">&para;</a></h4>
<p>在Web API的上下文中，序列化参数dump_only和反序列化参数load_only在概念上分别等同于只读和只写字段。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span><span class="n">fields</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">()</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>    <span class="n">password</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="n">load_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 等于只写</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>    <span class="n">created_at</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(</span><span class="n">dump_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 等于只读</span>
</code></pre></div>
<p>load时，dump_only字段被视为未知字段。如果unknown选项设置为include，则与这些字段对应的键的值将因此loaded而不进行验证。</p>
<h4 id="12">12. 序列化/反序列化时指定字段的默认值<a class="headerlink" href="#12" title="Permanent link">&para;</a></h4>
<p>序列化时输入值缺失用default指定默认值。反序列化时输入值缺失用missing指定默认值。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1">#encoding=utf-8</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="kn">import</span> <span class="nn">uuid</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">fields</span><span class="p">,</span><span class="n">ValidationError</span><span class="p">,</span><span class="n">Schema</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="k">class</span> <span class="nc">UserSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">missing</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">)</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>    <span class="n">birthday</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1996</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">17</span><span class="p">))</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="c1"># 序列化</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="n">res</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span><span class="o">.</span><span class="n">dump</span><span class="p">({})</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="c1"># {&#39;birthday&#39;: &#39;1996-11-17T00:00:00&#39;}</span>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="c1"># 反序列化</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="n">res</span> <span class="o">=</span> <span class="n">UserSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s1">&#39;birthday&#39;</span><span class="p">:</span> <span class="s1">&#39;1996-11-17T00:00:00&#39;</span><span class="p">})</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="c1"># {&#39;id&#39;: UUID(&#39;751d95db-c020-11eb-83eb-001a7dda7115&#39;), &#39;birthday&#39;: datetime.datetime(1996, 11, 17, 0, 0)}</span>
</code></pre></div>
<h4 id="13">13. 后续扩展<a class="headerlink" href="#13" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">fields</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="k">class</span> <span class="nc">String128</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">):</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="sd">    长度为128的字符串类型</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>    <span class="n">default_error_messages</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;该字段只能是字符串类型&quot;</span><span class="p">,</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>        <span class="s2">&quot;invalid&quot;</span><span class="p">:</span> <span class="s2">&quot;该字符串长度必须大于6&quot;</span><span class="p">,</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>    <span class="p">}</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>    <span class="k">def</span> <span class="nf">_deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="k">class</span> <span class="nc">AppSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">String128</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a>    <span class="n">priority</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">()</span>
<a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a>    <span class="n">obj_type</span> <span class="o">=</span> <span class="n">String128</span><span class="p">()</span>
<a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a>    <span class="n">link</span> <span class="o">=</span> <span class="n">String128</span><span class="p">()</span>
<a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a>    <span class="n">deploy</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span>
<a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a>    <span class="n">description</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">()</span>
<a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a>    <span class="n">projects</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">cls_or_instance</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">Dict</span><span class="p">)</span>
<a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a>
<a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a>
<a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a><span class="n">app</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a>    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;app11&quot;</span><span class="p">,</span>
<a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a>    <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-30-34" name="__codelineno-30-34" href="#__codelineno-30-34"></a>    <span class="s2">&quot;obj_type&quot;</span><span class="p">:</span> <span class="s2">&quot;web&quot;</span><span class="p">,</span>
<a id="__codelineno-30-35" name="__codelineno-30-35" href="#__codelineno-30-35"></a>    <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;123.123.00.2&quot;</span><span class="p">,</span>
<a id="__codelineno-30-36" name="__codelineno-30-36" href="#__codelineno-30-36"></a>    <span class="s2">&quot;deploy&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;deploy1&quot;</span><span class="p">:</span> <span class="s2">&quot;deploy1&quot;</span><span class="p">,</span> <span class="s2">&quot;deploy2&quot;</span><span class="p">:</span> <span class="s2">&quot;deploy2&quot;</span><span class="p">},</span>
<a id="__codelineno-30-37" name="__codelineno-30-37" href="#__codelineno-30-37"></a>    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;app111 test111&quot;</span><span class="p">,</span>
<a id="__codelineno-30-38" name="__codelineno-30-38" href="#__codelineno-30-38"></a>    <span class="s2">&quot;projects&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}]</span>
<a id="__codelineno-30-39" name="__codelineno-30-39" href="#__codelineno-30-39"></a><span class="p">}</span>
<a id="__codelineno-30-40" name="__codelineno-30-40" href="#__codelineno-30-40"></a>
<a id="__codelineno-30-41" name="__codelineno-30-41" href="#__codelineno-30-41"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">AppSchema</span><span class="p">()</span>
<a id="__codelineno-30-42" name="__codelineno-30-42" href="#__codelineno-30-42"></a><span class="n">res</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-30-43" name="__codelineno-30-43" href="#__codelineno-30-43"></a><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-30-44" name="__codelineno-30-44" href="#__codelineno-30-44"></a><span class="c1"># {&#39;obj_type&#39;: [&#39;该字符串长度必须大于6&#39;], &#39;name&#39;: [&#39;该字符串长度必须大于6&#39;]}</span>
</code></pre></div>
<blockquote>
<p><a href="https://marshmallow.readthedocs.io/en/stable/">marshmallow: simplified object serialization — marshmallow 3.15.0 documentation</a></p>
</blockquote>
<h3 id="webargs"><code>webargs</code><a class="headerlink" href="#webargs" title="Permanent link">&para;</a></h3>
<p><code>webargs</code>是用来参数解析和校验参数的工具。</p>
<h4 id="_6">使用示例<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="kn">from</span> <span class="nn">webargs</span> <span class="kn">import</span> <span class="n">fields</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="kn">from</span> <span class="nn">webargs.flaskparser</span> <span class="kn">import</span> <span class="n">use_args</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="nd">@use_args</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)},</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;query&quot;</span><span class="p">)</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>    <span class="k">return</span> <span class="s2">&quot;Hello &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>
<a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="c1"># curl http://localhost:5000/\?name\=&#39;World&#39;</span>
<a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="c1"># Hello World</span>
</code></pre></div>
<p>默认情况下，<code>webargs</code>会自动解析<code>json body</code>数据。但是也支持其他类型。需要手动指定数据来源，设置方式为<code>location=xxx</code>("form", "query","json","headers", "cookies", "files", "paths")</p>
<blockquote>
<p>更多使用方式及功能支持可参见官方文档：<a href="https://webargs.readthedocs.io/en/latest/">webargs 8.1.0 documentation</a></p>
</blockquote>
<h3 id="flask-apispec"><code>flask-apispec</code><a class="headerlink" href="#flask-apispec" title="Permanent link">&para;</a></h3>
<p><code>flask-apispec</code> 是一款轻量级能自动生成<code>REST APIs</code>的<code>Flask</code>工具。使用了<code>webargs</code>做<code>request</code>解析，<code>marshmallow</code>做<code>response</code>格式化，和<code>apispec</code>自动生成<code>Swagger</code>。</p>
<h4 id="_7">下载安装<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">flask</span><span class="o">-</span><span class="n">apispec</span>
</code></pre></div>
<h4 id="_8">使用实例<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="kn">from</span> <span class="nn">flask_apispec</span> <span class="kn">import</span> <span class="n">use_kwargs</span><span class="p">,</span> <span class="n">marshal_with</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="kn">from</span> <span class="nn">webargs</span> <span class="kn">import</span> <span class="n">fields</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Pet</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="k">class</span> <span class="nc">PetSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">)</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/pets&#39;</span><span class="p">)</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="nd">@use_kwargs</span><span class="p">({</span><span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">(),</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">()})</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="nd">@marshal_with</span><span class="p">(</span><span class="n">PetSchema</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="k">def</span> <span class="nf">get_pets</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>    <span class="k">return</span> <span class="n">Pet</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
<h4 id="_9">项目中使用实例<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># apps/__init__.py</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="k">def</span> <span class="nf">register_apispec</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>    <span class="kn">from</span> <span class="nn">apispec</span> <span class="kn">import</span> <span class="n">APISpec</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>    <span class="kn">from</span> <span class="nn">apispec.ext.marshmallow</span> <span class="kn">import</span> <span class="n">MarshmallowPlugin</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>    <span class="kn">from</span> <span class="nn">util.flask_apispec</span> <span class="kn">import</span> <span class="n">FlaskPlugin</span><span class="p">,</span> <span class="n">FlaskApiSpec</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>    <span class="kn">from</span> <span class="nn">webargs.flaskparser</span> <span class="kn">import</span> <span class="n">FlaskParser</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>    <span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">EXCLUDE</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>    <span class="c1"># 设置json参数校验时未知参数处理方式为丢弃未知字段</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>    <span class="k">class</span> <span class="nc">Parser</span><span class="p">(</span><span class="n">FlaskParser</span><span class="p">):</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>        <span class="n">DEFAULT_UNKNOWN_BY_LOCATION</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="n">EXCLUDE</span><span class="p">}</span>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
<a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>        <span class="s1">&#39;APISPEC_SPEC&#39;</span><span class="p">:</span> <span class="n">APISpec</span><span class="p">(</span>
<a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;POROS&quot;</span><span class="p">,</span>
<a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>            <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>            <span class="n">openapi_version</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>            <span class="n">info</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;POROS API&quot;</span><span class="p">),</span>
<a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a>            <span class="n">plugins</span><span class="o">=</span><span class="p">[</span><span class="n">FlaskPlugin</span><span class="p">(),</span> <span class="n">MarshmallowPlugin</span><span class="p">()],</span>
<a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a>        <span class="p">),</span>
<a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a>        <span class="s1">&#39;APISPEC_FORMAT_RESPONSE&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a>        <span class="s1">&#39;APISPEC_WEBARGS_PARSER&#39;</span><span class="p">:</span> <span class="n">Parser</span><span class="p">(),</span>  <span class="c1"># 启用指定解析器</span>
<a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a>    <span class="p">})</span>
<a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a>    <span class="n">docs</span> <span class="o">=</span> <span class="n">FlaskApiSpec</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">document_options</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a>    <span class="n">docs</span><span class="o">.</span><span class="n">register_existing_resources</span><span class="p">()</span>
</code></pre></div>
<blockquote>
<p>官方文档:<a href="https://flask-apispec.readthedocs.io/en/latest/index.html">flask-apispec: Auto-documenting REST APIs for Flask — flask-apispec 0.7.0 documentation</a> </p>
<p>源码：<a href="https://github.com/jmcarp/flask-apispec">jmcarp/flask-apispec (github.com)</a></p>
</blockquote>
<h3 id="mongoengine"><code>mongoengine</code><a class="headerlink" href="#mongoengine" title="Permanent link">&para;</a></h3>
<p><code>MongoEngine</code>是一个基于<code>pymongo</code>开发的<code>ODM</code>库，对应与<code>SQLAlchemy</code>。同时，在<code>MongoEngine</code>基础上封装了<code>Flask-MongoEngine</code>，用于支持<code>flask</code>框架。</p>
<h4 id="1">1 连接数据库<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<h5 id="11_1">1.1 多种连接方式<a class="headerlink" href="#11_1" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kn">from</span> <span class="nn">mongoengine</span> <span class="kn">import</span> <span class="n">connect</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="c1"># 方法一：本地连接</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;dbname&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s1">&#39;别名&#39;</span><span class="p">)</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="c1"># 方法二：远程连接</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;dbname&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;远程连接地址&#39;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="n">端口号</span><span class="p">)</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="c1"># 方法三：连接带有验证的远程数据库</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;dbname&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;用户名&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;密码&#39;</span><span class="p">,</span> <span class="n">authentication_source</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span>  <span class="n">host</span><span class="o">=</span><span class="s1">&#39;远程服务器IP地址&#39;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="n">开放的端口号</span><span class="p">))</span>
</code></pre></div>
<h5 id="12_1">1.2 连接多个数据库<a class="headerlink" href="#12_1" title="Permanent link">&para;</a></h5>
<p>要使用多个数据库，您可以使用connect()并为连接提供别名(alisa)，默认使用“default”。
在后台，这用于register_connection()存储数据，如果需要，您可以预先注册所有别名。</p>
<ul>
<li>在不同数据库中定义文档</li>
</ul>
<p>通过在元数据中提供db_alias，可以将各个文档附加到不同的数据库 。这允许DBRef 对象指向数据库和集合。下面是一个示例模式，使用3个不同的数据库来存储数据</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1"># 默认本地连接</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="n">connect</span> <span class="p">(</span><span class="n">alias</span> <span class="o">=</span> <span class="s1">&#39;user-db-alias&#39;</span> <span class="err">，</span> <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;user-db&#39;</span> <span class="p">)</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">connect</span> <span class="p">(</span><span class="n">alias</span> <span class="o">=</span> <span class="s1">&#39;book-db-alias&#39;</span> <span class="err">，</span> <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;book-db&#39;</span> <span class="p">)</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="n">connect</span> <span class="p">(</span><span class="n">alias</span> <span class="o">=</span> <span class="s1">&#39;users-books-db -alias&#39;</span> <span class="err">，</span> <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;users-books-db&#39;</span> <span class="p">)</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="k">class</span>  <span class="nc">User</span> <span class="p">(</span><span class="n">Document</span> <span class="p">)</span><span class="err">：</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>    <span class="n">name</span>  <span class="o">=</span>  <span class="n">StringField</span> <span class="p">()</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>    <span class="n">meta</span>  <span class="o">=</span>  <span class="p">{</span> <span class="s1">&#39;db_alias&#39;</span> <span class="err">：</span> <span class="s1">&#39;user-db-alias&#39;</span> <span class="p">}</span>   <span class="c1"># 指定数据对应的数据库</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="k">class</span>  <span class="nc">Book</span><span class="p">(</span><span class="n">Document</span> <span class="p">)</span><span class="err">：</span>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>    <span class="n">name</span>  <span class="o">=</span>  <span class="n">StringField</span> <span class="p">()</span>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>    <span class="n">meta</span>  <span class="o">=</span>  <span class="p">{</span> <span class="s1">&#39;db_alias&#39;</span> <span class="err">：</span> <span class="s1">&#39;book-db-alias&#39;</span> <span class="p">}</span> 
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a><span class="k">class</span>  <span class="nc">AuthorBooks</span> <span class="p">(</span><span class="n">Document</span> <span class="p">)</span><span class="err">：</span>
<a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a>    <span class="n">author</span>  <span class="o">=</span>  <span class="n">ReferenceField</span> <span class="p">(</span><span class="n">User</span> <span class="p">)</span>
<a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a>    <span class="n">book</span>  <span class="o">=</span>  <span class="n">ReferenceField</span> <span class="p">(</span><span class="n">Book</span> <span class="p">)</span>
<a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>    <span class="n">meta</span>  <span class="o">=</span>  <span class="p">{</span> <span class="s1">&#39;db_alias&#39;</span> <span class="err">：</span> <span class="s1">&#39; users-books-db-alias&#39;</span> <span class="p">}</span>
</code></pre></div>
<ul>
<li>断开现有连接</li>
</ul>
<p><code>disconnect</code>可用于断开特定连接。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="kn">from</span> <span class="nn">mongoengine</span> <span class="kn">import</span> <span class="n">connect</span><span class="p">,</span> <span class="n">disconnect</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;a_db&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s1">&#39;db1&#39;</span><span class="p">)</span>    <span class="c1"># ==》 建立别名为“db1”的连接</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;db_alias&#39;</span><span class="p">:</span> <span class="s1">&#39;db1&#39;</span><span class="p">}</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="n">disconnect</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="s1">&#39;db1&#39;</span><span class="p">)</span>   <span class="c1"># ==》 断开 别名为“db1”的连接</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;another_db&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s1">&#39;db1&#39;</span><span class="p">)</span>      <span class="c1"># ==》 由于上一步断开了别名为db1的连接，现在连接其它数据库时又可以使用别名“db1”作为连接名</span>
</code></pre></div>
<h5 id="13_1">1.3 上下文管理器<a class="headerlink" href="#13_1" title="Permanent link">&para;</a></h5>
<p>有时您可能希望切换数据库或集合以进行查询</p>
<ul>
<li>切换数据库</li>
</ul>
<p><code>switch_db</code>上允许更改数据库别名给定类，允许快速和方便地跨数据库访问：</p>
<blockquote>
<p>切换数据库，必须预先注册别名(使用已注册的别名)</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="kn">from</span> <span class="nn">mongoengine.context_managers</span> <span class="kn">import</span> <span class="n">switch_db</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;db_alias&#39;</span><span class="p">:</span> <span class="s1">&#39;user-db&#39;</span><span class="p">}</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="k">with</span> <span class="n">switch_db</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="s1">&#39;archive-user-db&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">User</span><span class="p">:</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>    <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Ross&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1">#  ===》 这时会将数据保存至 &#39;archive-user-db&#39;</span>
</code></pre></div>
<ul>
<li>切换文档</li>
</ul>
<p><code>switch_collection()</code>上下文管理器允许更改集合，允许快速和方便地跨集合访问：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="kn">from</span> <span class="nn">mongoengine.context_managers</span> <span class="kn">import</span> <span class="n">switch_collection</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="n">Group</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1"># 保存至默认数据库</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="k">with</span> <span class="n">switch_collection</span><span class="p">(</span><span class="n">Group</span><span class="p">,</span> <span class="s1">&#39;group2000&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">Group</span><span class="p">:</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>    <span class="n">Group</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;hello Group 2000 collection!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1"># 将数据保存至 group2000 集合</span>
</code></pre></div>
<h4 id="2">2 定义文档<a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<h5 id="21-document">2.1 定义文档模型(document)<a class="headerlink" href="#21-document" title="Permanent link">&para;</a></h5>
<p><code>MongoEngine</code>允许为文档定义模式，因为这有助于减少编码错误，并允许在可能存在的字段上定义方法。
为文档定义模式，需创建一个继承自<code>Document</code>的类，将字段对象作为类属性添加到文档类：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kn">from</span> <span class="nn">mongoengine</span> <span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="kn">import</span> <span class="nn">datetime</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>    <span class="n">title</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>      <span class="c1"># ===》 创建一个String型的字段title，最大长度为200字节且为必填项</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>    <span class="n">date_modified</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>      <span class="c1"># ===》 创建一个时间类型的字段(utcnow是世界时间，now是本地计算机时间)</span>
</code></pre></div>
<h5 id="22-dynamic-document">2.2 定义动态文档模型(Dynamic Document)<a class="headerlink" href="#22-dynamic-document" title="Permanent link">&para;</a></h5>
<p>动态文档(Dynamic Document)跟非动态文档(document)的区别是，动态文档可以在模型基础上新增字段，但非动态文档不允许新增。</p>
<blockquote>
<p>动态文档中自定义字段不能以 <code>_</code>开头</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="kn">from</span> <span class="nn">mongoengine</span> <span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="n">DynamicDocument</span><span class="p">):</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>    <span class="n">title</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="c1"># 创建一个page实例，并新增tags字段</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Using MongoEngine&#39;</span><span class="p">)</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mongodb&#39;</span><span class="p">,</span> <span class="s1">&#39;mongoengine&#39;</span><span class="p">]</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>      <span class="o">=====</span><span class="err">》</span><span class="c1"># 不会报错，可以被保存至数据库</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">Page</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="s1">&#39;mongoengine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>      <span class="o">=====</span><span class="err">》</span><span class="c1"># 统计 tags=‘mongengine’的文档数</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span>
</code></pre></div>
<h5 id="23-fields">2.3 字段Fields<a class="headerlink" href="#23-fields" title="Permanent link">&para;</a></h5>
<p>字段类型包含：</p>
<blockquote>
<p>以 <code>》</code>开头的为常用类型</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="err">》</span><span class="n">BinaryField</span>    <span class="c1">#  二进制字段</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="err">》</span><span class="n">BooleanField</span>     <span class="c1"># 布尔型字段</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="err">》</span><span class="n">DateTimeField</span>    <span class="c1"># 后六位精确到毫妙的时间类型字段</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="n">ComplexDateTimeField</span>   <span class="c1"># 后六位精确到微妙的时间类型字段</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="n">DecimalField</span>    <span class="c1"># </span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="err">》</span><span class="n">DictField</span>    <span class="c1"># 字典类型字段</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="err">》</span><span class="n">DynamicField</span>   <span class="c1"># 动态类型字段，能够处理不同类型的数据</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="err">》</span><span class="n">EmailField</span>     <span class="c1"># 邮件类型字段</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="err">》</span><span class="n">EmbeddedDocumentField</span>   <span class="c1"># 嵌入式文档类型</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="err">》</span><span class="n">StringField</span>    <span class="c1"># 字符串类型字段</span>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="err">》</span><span class="n">URLField</span>    <span class="c1"># URL类型字段</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="err">》</span><span class="n">SequenceField</span>     <span class="c1"># 顺序计数器字段，自增长</span>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="err">》</span><span class="n">ListField</span>       <span class="c1"># 列表类型字段</span>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="err">》</span><span class="n">ReferenceField</span>    <span class="c1"># 引用类型字段</span>
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="n">LazyReferenceField</span>
<a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="err">》</span><span class="n">IntField</span>     <span class="c1"># 整数类型字段，存储大小为32字节</span>
<a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a><span class="n">LongField</span>      <span class="c1"># 长整型字段，存储大小为64字节</span>
<a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a><span class="n">EmbeddedDocumentListField</span>
<a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="n">FileField</span>  <span class="c1">#  列表类型字段</span>
<a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="n">FloatField</span>   <span class="c1"># 浮点数类型字段</span>
<a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a><span class="n">GenericEmbeddedDocumentField</span>   
<a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a><span class="n">GenericReferenceField</span>
<a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a><span class="n">GenericLazyReferenceField</span>
<a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a><span class="n">GeoPointField</span>
<a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a><span class="n">ImageField</span>
<a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a><span class="n">MapField</span>
<a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a><span class="n">ObjectIdField</span>
<a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a><span class="n">SortedListField</span>  
<a id="__codelineno-42-29" name="__codelineno-42-29" href="#__codelineno-42-29"></a><span class="n">UUIDField</span>
<a id="__codelineno-42-30" name="__codelineno-42-30" href="#__codelineno-42-30"></a><span class="n">PointField</span>
<a id="__codelineno-42-31" name="__codelineno-42-31" href="#__codelineno-42-31"></a><span class="n">LineStringField</span>
<a id="__codelineno-42-32" name="__codelineno-42-32" href="#__codelineno-42-32"></a><span class="n">PolygonField</span>
<a id="__codelineno-42-33" name="__codelineno-42-33" href="#__codelineno-42-33"></a><span class="n">MultiPointField</span>
<a id="__codelineno-42-34" name="__codelineno-42-34" href="#__codelineno-42-34"></a><span class="n">MultiLineStringField</span>
<a id="__codelineno-42-35" name="__codelineno-42-35" href="#__codelineno-42-35"></a><span class="n">MultiPolygonField</span>
</code></pre></div>
<ul>
<li>
<p>字段通用参数</p>
</li>
<li>
<p><code>db_field</code>：<code>MongoDB</code> 字段名称</p>
</li>
<li>
<p><code>required</code>: 是否必填</p>
</li>
<li>
<p><code>default</code>:  默认值</p>
</li>
<li>
<p><code>unique</code>: 是否唯一</p>
</li>
<li>
<p><code>unique_with</code>:唯一字段列表</p>
</li>
<li>
<p><code>primary_key</code>: 主键</p>
</li>
<li>
<p><code>choices</code>：限制该字段的值(为列表、集合或元组中的一个)</p>
</li>
<li>
<p><code>validation</code>：可用于验证字段的值, callable将值作为参数，如果验证失败，则应引发ValidationError</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">def</span> <span class="nf">_not_empty</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;value can not be empty&#39;</span><span class="p">)</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">validation</span><span class="o">=</span><span class="n">_not_empty</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>列表字段(ListField)</p>
</li>
</ul>
<p>使用ListField字段类型可以向 Document添加项目列表。ListField将另一个字段对象作为其第一个参数，该参数指定可以在列表中存储哪些类型元素：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">class</span>  <span class="nc">Page</span><span class="p">(</span><span class="n">Document</span><span class="p">)</span><span class="err">：</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>    <span class="n">tags</span> <span class="o">=</span> <span class="n">ListField</span><span class="p">(</span><span class="n">StringField</span><span class="p">(</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">50</span><span class="p">))</span>   <span class="c1"># ===》 ListField中存放字符串字段</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="c1"># 应该可以存放任意类型字段</span>
</code></pre></div>
<ul>
<li>内嵌文档(Embedded Document)</li>
</ul>
<p>MongoDB能够将文档嵌入到其他文档中。要创建嵌入式文档模型，需要继承EmbeddedDocument：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c1"># 创建嵌入式文档模型</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">EmbeddedDocument</span><span class="p">):</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>    <span class="n">content</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="c1"># 创建文档模型，且将 Comment 嵌入Post.comments列表字段中</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>    <span class="n">comments</span> <span class="o">=</span> <span class="n">ListField</span><span class="p">(</span><span class="n">EmbeddedDocumentField</span><span class="p">(</span><span class="n">Comment</span><span class="p">))</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="n">comment1</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;Good work!&#39;</span><span class="p">)</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="n">comment2</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;Nice article!&#39;</span><span class="p">)</span>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="n">comment1</span><span class="p">,</span> <span class="n">comment2</span><span class="p">])</span>
</code></pre></div>
<ul>
<li>字典字段(Dictionary Fields)</li>
</ul>
<p>一般建议使用嵌套文档，这样可以验证数据等等。但是，当你不知道想要存储什么结构时，可以使用字典字段（字典字段不支持验证），字典可以存储复杂数据，其他字典，列表，对其他对象的引用，因此是最灵活的字段类型：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">class</span> <span class="nc">SurveyResponse</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>    <span class="n">date</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">()</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>    <span class="n">user</span> <span class="o">=</span> <span class="n">ReferenceField</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>    <span class="n">answers</span> <span class="o">=</span> <span class="n">DictField</span><span class="p">()</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="n">survey_response</span> <span class="o">=</span> <span class="n">SurveyResponse</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="n">response_form</span> <span class="o">=</span> <span class="n">ResponseForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="n">survey_response</span><span class="o">.</span><span class="n">answers</span> <span class="o">=</span> <span class="n">response_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">()</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="n">survey_response</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div>
<blockquote>
<p>更过字段类型参见：<a href="http://docs.mongoengine.org/guide/defining-documents.html#field-arguments">2.3. Defining documents — MongoEngine 0.24.1 documentation</a></p>
</blockquote>
<h5 id="24-indexes">2.4 索引 Indexes<a class="headerlink" href="#24-indexes" title="Permanent link">&para;</a></h5>
<p>为了能在数据库中更快查找数据，需要创建索引。索引可以在模型文档中的meta中指定索引字段以及索引方向。
可以通过在字段名前加上$来指定文本索引。可以通过在字段名前加上＃来指定散列索引</p>
<blockquote>
<p><a href="http://docs.mongoengine.org/guide/defining-documents.html#global-index-default-options">2.3. Defining documents — MongoEngine 0.24.1 documentation</a></p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>    <span class="n">category</span> <span class="o">=</span> <span class="n">IntField</span><span class="p">()</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>    <span class="n">title</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>    <span class="n">rating</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>    <span class="n">created</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">()</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>        <span class="s1">&#39;indexes&#39;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>            <span class="s1">&#39;title&#39;</span><span class="p">,</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>            <span class="s1">&#39;$title&#39;</span><span class="p">,</span>  <span class="c1">#   ====》  文本索引</span>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>            <span class="s1">&#39;#title&#39;</span><span class="p">,</span>  <span class="c1">#     =====》  哈希索引</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>            <span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;-rating&#39;</span><span class="p">),</span>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>            <span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;_cls&#39;</span><span class="p">),</span>
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>            <span class="p">{</span>
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a>                <span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">],</span> 
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a>                <span class="s1">&#39;expireAfterSeconds&#39;</span><span class="p">:</span> <span class="mi">3600</span>       <span class="c1">#   ====》  设置文档在3600秒后过期，数据库会在3600秒后删除过期文档</span>
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a>            <span class="p">}</span>
<a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a>        <span class="p">]</span>
<a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a>    <span class="p">}</span>
</code></pre></div>
<ul>
<li>全局索引默认选项</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>    <span class="n">title</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>    <span class="n">rating</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>        <span class="s1">&#39;index_opts&#39;</span><span class="p">:</span> <span class="p">{},</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>        <span class="s1">&#39;index_background&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>        <span class="s1">&#39;index_cls&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>        <span class="s1">&#39;auto_create_index&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a>        <span class="s1">&#39;index_drop_dups&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>    <span class="p">}</span>
</code></pre></div>
<p>参数说明：</p>
<ul>
<li><code>index_opts</code>: 设置默认索引选项</li>
<li><code>index_background</code>: 为 <code>True</code> 时，后台创建索引</li>
<li><code>index_cls</code>: 一种关闭 <code>_cls</code> 的特定索引的方法</li>
<li><code>auto_create_index</code>: 默认为 <code>True</code>。<code>MongoEngine</code>将确保每次运行命令时<code>MongoDB</code>中都存在正确的索引。可以在单独管理索引的系统中禁用此功能。禁用此功能可以提高性能。</li>
</ul>
<h5 id="25">2.5 抽象类<a class="headerlink" href="#25" title="Permanent link">&para;</a></h5>
<p>如果你想为文档添加一些属性，且不想增加继承。可以使用在 <code>meta</code> 中使用 <code>abstract: True</code>.</p>
<p>示例：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="k">class</span> <span class="nc">BaseDynamicDocument</span><span class="p">(</span><span class="n">DynamicDocument</span><span class="p">):</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>    <span class="sd">&quot;&quot;&quot;所有model都继承此类, 统一的方法写在此类里&quot;&quot;&quot;</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;abstract&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_id</span><span class="p">,</span> <span class="n">only_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>        <span class="n">_obj</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>        <span class="n">_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">only_active</span><span class="o">=</span><span class="n">only_active</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="n">_id</span><span class="p">)</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">_obj</span> <span class="ow">and</span> <span class="n">raise_error</span><span class="p">:</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>            <span class="n">table_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;TABLE_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">table_name</span><span class="p">:</span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">类没有指定TABLE_NAME&#39;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a>            <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;get_by_id not found object. class_name: </span><span class="si">%s</span><span class="s1">, table_name: </span><span class="si">%s</span><span class="s1">, _id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
<a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a>                      <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">_id</span><span class="p">)</span>
<a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a>            <span class="n">logger_error</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a>            <span class="k">raise</span> <span class="n">BaseError</span><span class="p">(</span><span class="n">RetCodeAndMessage</span><span class="o">.</span><span class="n">Common</span><span class="o">.</span><span class="n">miss_obj</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
<a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a>        <span class="k">return</span> <span class="n">_obj</span>
<a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a>
<a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a>    <span class="k">def</span> <span class="nf">find_one</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">only_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">only_active</span><span class="o">=</span><span class="n">only_active</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a>
<a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">only_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a>        <span class="k">if</span> <span class="n">only_active</span> <span class="ow">and</span> <span class="s1">&#39;deleted&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a>            <span class="c1"># 踢出被逻辑删除的文档</span>
<a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">BooleanField</span><span class="p">):</span>
<a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a>                <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;deleted__ne&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">IntField</span><span class="p">):</span>
<a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a>                <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;deleted__ne&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a>
<a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a>        <span class="k">if</span> <span class="s1">&#39;ts&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-49-37" name="__codelineno-49-37" href="#__codelineno-49-37"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-49-38" name="__codelineno-49-38" href="#__codelineno-49-38"></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span>
<a id="__codelineno-49-39" name="__codelineno-49-39" href="#__codelineno-49-39"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">FloatField</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;ts&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-49-40" name="__codelineno-49-40" href="#__codelineno-49-40"></a>            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>
<a id="__codelineno-49-41" name="__codelineno-49-41" href="#__codelineno-49-41"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;create_time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">StringField</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;create_time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-49-42" name="__codelineno-49-42" href="#__codelineno-49-42"></a>            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;create_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="n">timestamp_to_datetime_str</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
<a id="__codelineno-49-43" name="__codelineno-49-43" href="#__codelineno-49-43"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">StringField</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;dt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-49-44" name="__codelineno-49-44" href="#__codelineno-49-44"></a>            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="n">timestamp_to_datetime_str</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">DateUtil</span><span class="o">.</span><span class="n">DATE_FORMAT</span><span class="p">)</span>
<a id="__codelineno-49-45" name="__codelineno-49-45" href="#__codelineno-49-45"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;create_dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">StringField</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;create_dt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-49-46" name="__codelineno-49-46" href="#__codelineno-49-46"></a>            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;create_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="n">timestamp_to_datetime_str</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">DateUtil</span><span class="o">.</span><span class="n">DATE_FORMAT</span><span class="p">)</span>
<a id="__codelineno-49-47" name="__codelineno-49-47" href="#__codelineno-49-47"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-49-48" name="__codelineno-49-48" href="#__codelineno-49-48"></a>
<a id="__codelineno-49-49" name="__codelineno-49-49" href="#__codelineno-49-49"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-49-50" name="__codelineno-49-50" href="#__codelineno-49-50"></a>    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_id</span><span class="p">,</span> <span class="n">only_active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-49-51" name="__codelineno-49-51" href="#__codelineno-49-51"></a>        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">only_active</span><span class="o">=</span><span class="n">only_active</span><span class="p">)</span>
<a id="__codelineno-49-52" name="__codelineno-49-52" href="#__codelineno-49-52"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
<a id="__codelineno-49-53" name="__codelineno-49-53" href="#__codelineno-49-53"></a>            <span class="n">pk_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;_meta&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id_field&#39;</span><span class="p">)</span>
<a id="__codelineno-49-54" name="__codelineno-49-54" href="#__codelineno-49-54"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">pk_name</span><span class="p">:</span> <span class="n">_id</span><span class="p">})</span>
<a id="__codelineno-49-55" name="__codelineno-49-55" href="#__codelineno-49-55"></a>        <span class="k">return</span> <span class="n">obj</span>
<a id="__codelineno-49-56" name="__codelineno-49-56" href="#__codelineno-49-56"></a>
<a id="__codelineno-49-57" name="__codelineno-49-57" href="#__codelineno-49-57"></a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_del</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">write_concern</span><span class="p">):</span>
<a id="__codelineno-49-58" name="__codelineno-49-58" href="#__codelineno-49-58"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_del</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-49-59" name="__codelineno-49-59" href="#__codelineno-49-59"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;delete_time&#39;</span><span class="p">):</span>
<a id="__codelineno-49-60" name="__codelineno-49-60" href="#__codelineno-49-60"></a>                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;delete_time&#39;</span><span class="p">,</span> <span class="n">DateUtil</span><span class="o">.</span><span class="n">datetime_to_str</span><span class="p">())</span>
<a id="__codelineno-49-61" name="__codelineno-49-61" href="#__codelineno-49-61"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">BooleanField</span><span class="p">)</span> \
<a id="__codelineno-49-62" name="__codelineno-49-62" href="#__codelineno-49-62"></a>                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">bool</span><span class="p">):</span>
<a id="__codelineno-49-63" name="__codelineno-49-63" href="#__codelineno-49-63"></a>                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-49-64" name="__codelineno-49-64" href="#__codelineno-49-64"></a>                <span class="nb">super</span><span class="p">(</span><span class="n">BaseDynamicDocument</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<a id="__codelineno-49-65" name="__codelineno-49-65" href="#__codelineno-49-65"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">IntField</span><span class="p">)</span> \
<a id="__codelineno-49-66" name="__codelineno-49-66" href="#__codelineno-49-66"></a>                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-49-67" name="__codelineno-49-67" href="#__codelineno-49-67"></a>                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-49-68" name="__codelineno-49-68" href="#__codelineno-49-68"></a>                <span class="nb">super</span><span class="p">(</span><span class="n">BaseDynamicDocument</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<a id="__codelineno-49-69" name="__codelineno-49-69" href="#__codelineno-49-69"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-49-70" name="__codelineno-49-70" href="#__codelineno-49-70"></a>                <span class="n">DingTalkMessage</span><span class="p">()</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span>
<a id="__codelineno-49-71" name="__codelineno-49-71" href="#__codelineno-49-71"></a>                    <span class="s1">&#39;class:</span><span class="si">%s</span><span class="s1"> deleted type:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))))</span>
<a id="__codelineno-49-72" name="__codelineno-49-72" href="#__codelineno-49-72"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-49-73" name="__codelineno-49-73" href="#__codelineno-49-73"></a>            <span class="nb">super</span><span class="p">(</span><span class="n">BaseDynamicDocument</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">**</span><span class="n">write_concern</span><span class="p">)</span>
<a id="__codelineno-49-74" name="__codelineno-49-74" href="#__codelineno-49-74"></a>
<a id="__codelineno-49-75" name="__codelineno-49-75" href="#__codelineno-49-75"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-49-76" name="__codelineno-49-76" href="#__codelineno-49-76"></a>    <span class="k">def</span> <span class="nf">delete_batch</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db_del</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-49-77" name="__codelineno-49-77" href="#__codelineno-49-77"></a>        <span class="sd">&quot;&quot;&quot;批量删除&quot;&quot;&quot;</span>
<a id="__codelineno-49-78" name="__codelineno-49-78" href="#__codelineno-49-78"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_del</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-49-79" name="__codelineno-49-79" href="#__codelineno-49-79"></a>            <span class="n">update_str</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-49-80" name="__codelineno-49-80" href="#__codelineno-49-80"></a>            <span class="n">now</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="n">datetime_to_str</span><span class="p">()</span>
<a id="__codelineno-49-81" name="__codelineno-49-81" href="#__codelineno-49-81"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;delete_time&#39;</span><span class="p">):</span>
<a id="__codelineno-49-82" name="__codelineno-49-82" href="#__codelineno-49-82"></a>                <span class="n">update_str</span><span class="p">[</span><span class="s1">&#39;delete_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
<a id="__codelineno-49-83" name="__codelineno-49-83" href="#__codelineno-49-83"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">BooleanField</span><span class="p">):</span>
<a id="__codelineno-49-84" name="__codelineno-49-84" href="#__codelineno-49-84"></a>                <span class="n">update_str</span><span class="p">[</span><span class="s1">&#39;deleted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-49-85" name="__codelineno-49-85" href="#__codelineno-49-85"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">IntField</span><span class="p">):</span>
<a id="__codelineno-49-86" name="__codelineno-49-86" href="#__codelineno-49-86"></a>                <span class="n">update_str</span><span class="p">[</span><span class="s1">&#39;deleted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-49-87" name="__codelineno-49-87" href="#__codelineno-49-87"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-49-88" name="__codelineno-49-88" href="#__codelineno-49-88"></a>                <span class="n">DingTalkMessage</span><span class="p">()</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span>
<a id="__codelineno-49-89" name="__codelineno-49-89" href="#__codelineno-49-89"></a>                    <span class="s1">&#39;class:</span><span class="si">%s</span><span class="s1"> deleted type:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))))</span>
<a id="__codelineno-49-90" name="__codelineno-49-90" href="#__codelineno-49-90"></a>            <span class="bp">cls</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">update_str</span><span class="p">)</span>
<a id="__codelineno-49-91" name="__codelineno-49-91" href="#__codelineno-49-91"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-49-92" name="__codelineno-49-92" href="#__codelineno-49-92"></a>            <span class="bp">cls</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<a id="__codelineno-49-93" name="__codelineno-49-93" href="#__codelineno-49-93"></a>
<a id="__codelineno-49-94" name="__codelineno-49-94" href="#__codelineno-49-94"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-49-95" name="__codelineno-49-95" href="#__codelineno-49-95"></a>    <span class="k">def</span> <span class="nf">get_batch_by_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">only_active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-49-96" name="__codelineno-49-96" href="#__codelineno-49-96"></a>        <span class="sd">&quot;&quot;&quot;批量获取obj_dict&quot;&quot;&quot;</span>
<a id="__codelineno-49-97" name="__codelineno-49-97" href="#__codelineno-49-97"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
<a id="__codelineno-49-98" name="__codelineno-49-98" href="#__codelineno-49-98"></a>            <span class="k">return</span> <span class="p">{}</span>
<a id="__codelineno-49-99" name="__codelineno-49-99" href="#__codelineno-49-99"></a>        <span class="n">objs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">_id__in</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">only_active</span><span class="o">=</span><span class="n">only_active</span><span class="p">)</span>
<a id="__codelineno-49-100" name="__codelineno-49-100" href="#__codelineno-49-100"></a>        <span class="n">objs_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">}</span>
<a id="__codelineno-49-101" name="__codelineno-49-101" href="#__codelineno-49-101"></a>        <span class="k">return</span> <span class="n">objs_dict</span>
<a id="__codelineno-49-102" name="__codelineno-49-102" href="#__codelineno-49-102"></a>
<a id="__codelineno-49-103" name="__codelineno-49-103" href="#__codelineno-49-103"></a>    <span class="nd">@queryset_manager</span>
<a id="__codelineno-49-104" name="__codelineno-49-104" href="#__codelineno-49-104"></a>    <span class="k">def</span> <span class="nf">objects_not_delete</span><span class="p">(</span><span class="n">doc_cls</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
<a id="__codelineno-49-105" name="__codelineno-49-105" href="#__codelineno-49-105"></a>        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">deleted</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<h5 id="26">2.6 文档实例<a class="headerlink" href="#26" title="Permanent link">&para;</a></h5>
<p>实例化一个对象。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>    <span class="n">title</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;allow_inheritance&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Test Page&quot;</span><span class="p">)</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="o">.</span><span class="n">title</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="s1">&#39;Test Page&#39;</span>
</code></pre></div>
<ul>
<li>持久化和删除文档</li>
</ul>
<p>使用<code>save()</code>方法即可持久化数据</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Test Page&quot;</span><span class="p">)</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1"># 保存</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;My Page&quot;</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1"># 修改title值后 再次保存</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="o">.</span><span class="n">id</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="n">ObjectId</span><span class="p">(</span><span class="s1">&#39;123456789abcdef000000000&#39;</span><span class="p">)</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">page</span><span class="o">.</span><span class="n">pk</span>  <span class="c1"># 查找主键</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="n">ObjectId</span><span class="p">(</span><span class="s1">&#39;123456789abcdef000000000&#39;</span><span class="p">)</span>
</code></pre></div>
<p>使用 <code>delete</code> 即可删除文档</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="n">delete</span><span class="p">(</span><span class="n">signal_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">write_concern</span><span class="p">)</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="c1"># 示例</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="n">p</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;My Page&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="n">p</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</code></pre></div>
<h5 id="27">2.7 查询文档<a class="headerlink" href="#27" title="Permanent link">&para;</a></h5>
<p><code>Document</code>类具有一个<code>objects</code>属性，用于访问与类关联的数据库中的对象。该<code>objects</code>属性实际上是一个 <code>QuerySetManager</code>，它在访问时创建并返回一个新的<code>QuerySet</code>对象, 可以迭代该对象以从数据库中获取文档</p>
<p>使用示例：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c1"># 查询出国家是英国的所有用户</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="n">uk_users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">country</span><span class="o">=</span><span class="s1">&#39;uk&#39;</span><span class="p">)</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="c1"># auther是一个嵌入文档字段，country是嵌入文档的field，通过auther__country的方式访问值</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="n">uk_pages</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">author__country</span><span class="o">=</span><span class="s1">&#39;uk&#39;</span><span class="p">)</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="c1"># 查询18岁以下的用户</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="n">young_users</span> <span class="o">=</span> <span class="n">Users</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">age__lte</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</code></pre></div>
<p>常用的运算符如下：</p>
<ul>
<li><code>ne</code>: 不等于</li>
<li><code>lt</code>：小于</li>
<li><code>lte</code>： 小于等于</li>
<li><code>gt</code>: 大于</li>
<li><code>gte</code>： 大于等于</li>
<li><code>in</code>:  在列表中</li>
<li><code>nin</code>：不再值列表中</li>
<li><code>all</code>： 提供的值列表中的每个项目都在数组中（查询结果集为给定值集的子集）</li>
<li><code>size</code>： 数组大小</li>
<li><code>exists</code>: 字段值存在</li>
</ul>
<h6 id="_10"><strong>字符串查询</strong><a class="headerlink" href="#_10" title="Permanent link">&para;</a></h6>
<p>以下运算符可用作使用正则表达式查询：</p>
<ul>
<li><code>exact</code> - 字符串字段与值完全匹配</li>
<li><code>iexact</code> - 字符串字段与值完全匹配（不区分大小写）</li>
<li><code>contains</code> - 字符串字段包含值</li>
<li><code>icontains</code> - 字符串字段包含值（不区分大小写）</li>
<li><code>startswith</code> - 字符串字段以值开头</li>
<li><code>istartswith</code> - 字符串字段以值开头（不区分大小写）</li>
<li><code>endswith</code> - 字符串字段以值结尾</li>
<li><code>iendswith</code> - 字符串字段以值结尾（不区分大小写）</li>
<li><code>match</code> - 执行$ elemMatch，以便您可以匹配数组中的整个文档</li>
</ul>
<h6 id="_11">原始查询<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h6>
<p>如果希望使用pymongo操作数据库，可以使用__raw__关键字：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">Page</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">__raw__</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="s1">&#39;coding&#39;</span><span class="p">})</span>
</code></pre></div>
<blockquote>
<p><a href="https://www.mongodb.com/docs/drivers/pymongo/">PyMongo — MongoDB Drivers</a></p>
</blockquote>
<h6 id="_12">限制与跳过查询<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h6>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1"># 查询前五条文档</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="c1"># 查询第六条以后的所有文档</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="c1"># 查询第十一到第十五条文档</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="o">&gt;&gt;&gt;</span> <span class="c1"># 确认数据库中不存在文档</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">User</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">()</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="ne">IndexError</span><span class="p">:</span> <span class="nb">list</span> <span class="n">index</span> <span class="n">out</span> <span class="n">of</span> <span class="nb">range</span>   <span class="o">===</span><span class="err">》</span> <span class="n">报IndexError的错</span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span> <span class="o">==</span> <span class="kc">None</span>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="kc">True</span>
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Test User&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a><span class="kc">True</span>
</code></pre></div>
<h6 id="_13">聚合查询<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h6>
<p>常用聚合查询示例：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="c1"># 求总数</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="n">num_users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="c1"># 求和</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="n">yearly_expense</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;salary&#39;</span><span class="p">)</span>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="c1"># 求平均值</span>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="n">mean_age</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>
</code></pre></div>
<h6 id="_14">限制查询<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h6>
<p>搜索文档子集</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Film</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="o">...</span>     <span class="n">title</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="o">...</span>     <span class="n">year</span> <span class="o">=</span> <span class="n">IntField</span><span class="p">()</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="o">...</span>     <span class="n">rating</span> <span class="o">=</span> <span class="n">IntField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="o">...</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">Film</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;The Shawshank Redemption&#39;</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">1994</span><span class="p">,</span> <span class="n">rating</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">Film</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">title</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="s1">&#39;The Shawshank Redemption&#39;</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">year</span>   <span class="c1"># None</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">rating</span> <span class="c1"># default value</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="mi">3</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="n">post</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s1">&#39;author.name&#39;</span><span class="p">)</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="c1"># 查询出除了title和auther.name字段的内容</span>
</code></pre></div>
<h6 id="_15">高级查询<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h6>
<p>如果希望通过 or 或者 and 来多条件查询时，需要使用 Q(条件语句1) | Q(条件语句2) Q(条件语句1) | Q(条件语句2)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="kn">from</span> <span class="nn">mongoengine.queryset.visitor</span> <span class="kn">import</span> <span class="n">Q</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="c1"># 获取已发布的文档</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">published</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">publish_date__lte</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="c1"># 获取 featured为真 同时 hits大于等于1000或大于等于5000  的文档</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="p">((</span><span class="n">Q</span><span class="p">(</span><span class="n">featured</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Q</span><span class="p">(</span><span class="n">hits__gte</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">hits__gte</span><span class="o">=</span><span class="mi">5000</span><span class="p">))</span>
</code></pre></div>
<h6 id="_16">原子更新<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h6>
<p>更新方法有：<code>update(), update_one(), modify()</code>
更新修饰符有：</p>
<ul>
<li><code>set</code> - 重新设置一个值</li>
<li><code>unset</code> - 删除</li>
<li><code>inc</code> - 加</li>
<li><code>dec</code> - 减</li>
<li><code>push</code> - 将新值添加到列表中</li>
<li><code>push_all</code> - 将多个值添加到列表中</li>
<li><code>pop</code> - 根据值删除列表的第一个或最后一个元素</li>
<li><code>pull</code> - 从列表中删除值</li>
<li><code>pull_all</code> - 从列表中删除多个值</li>
<li><code>add_to_set</code> - 仅当列表中的值不在列表中时才为其添加值</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="n">page_views</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">])</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span><span class="n">inc__page_views</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>  <span class="c1"># 值已被修改，重新加载数据</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">page_views</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="mi">1</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span><span class="n">set__title</span><span class="o">=</span><span class="s1">&#39;Example Post&#39;</span><span class="p">)</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">title</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="s1">&#39;Example Post&#39;</span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span><span class="n">push__tags</span><span class="o">=</span><span class="s1">&#39;nosql&#39;</span><span class="p">)</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">tags</span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;nosql&#39;</span><span class="p">]</span>
</code></pre></div>
<p>⚠️注意：如果未指定修饰运算符，则默认为 <code>$set</code>.即下面两种写法是一样的</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Example Post&#39;</span><span class="p">)</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">set__title</span><span class="o">=</span><span class="s1">&#39;Example Post&#39;</span><span class="p">)</span>
</code></pre></div>
<blockquote>
<p><a href="https://www.cnblogs.com/zhenyauntg/p/13201826.html">MongoEngine中文文档 - zhenyuantg - 博客园 (cnblogs.com)</a></p>
</blockquote>
<h3 id="celery"><code>celery</code><a class="headerlink" href="#celery" title="Permanent link">&para;</a></h3>
<p><a href="https://www.jianshu.com/p/620052aadbff">Celery - 简书 (jianshu.com)</a></p>
<h2 id="_17">抓包开发<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h2>
<p>因为该项目客户端为<code>Android App</code>，所以<code>App</code>访问的资源需要通过抓包工具进行确认。</p>
<p>目前公司内所使用的工具是<code>mac OS</code> 上的<code>Charles</code>,使用该工具只需将手机上的 <code>wifi</code> 配置好指定的代理即可。</p>
<blockquote>
<p>可参见此文档进行设置：<a href="https://juejin.cn/post/6844904106255974413">Charles 手机抓包记录</a></p>
</blockquote>
<p>配置完成后，打开<code>App</code>即可看到抓包记录。</p>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            回到页面顶部
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="../.." class="md-footer__link md-footer__link--prev" aria-label="上一页: Home" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              Home
            </div>
          </div>
        </a>
      
      
        
        <a href="../%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/" class="md-footer__link md-footer__link--next" aria-label="下一页: 后端开发流程与开发规范" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              后端开发流程与开发规范
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6e54b5cd.min.js"></script>
      
    
  </body>
</html>